version: '3.8'

services:
  traefik:
    image: traefik:v2.11
    container_name: traefik
    restart: unless-stopped
    command:
      # Enable Docker provider
      - "--providers.docker=true"
      - "--providers.docker.exposedbydefault=false"
      
      # Entry points
      - "--entrypoints.web.address=:80"
      - "--entrypoints.websecure.address=:443"
      
      # HTTP to HTTPS redirect
      - "--entrypoints.web.http.redirections.entryPoint.to=websecure"
      - "--entrypoints.web.http.redirections.entryPoint.scheme=https"
      
      # Let's Encrypt configuration
      - "--certificatesresolvers.letsencrypt.acme.tlschallenge=true"
      - "--certificatesresolvers.letsencrypt.acme.email=${ACME_EMAIL}"
      - "--certificatesresolvers.letsencrypt.acme.storage=/letsencrypt/acme.json"
      
      # Enable dashboard (optional, for debugging)
      - "--api.dashboard=true"
      - "--api.insecure=false"
      
      # Logging
      - "--log.level=INFO"
      - "--accesslog=true"
    
    ports:
      - "80:80"
      - "443:443"
    
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro
      - traefik-certificates:/letsencrypt
    
    networks:
      - traefik-public
    
    labels:
      - "traefik.enable=true"
      # Dashboard (optional - remove if you don't want it)
      - "traefik.http.routers.dashboard.rule=Host(`traefik.${DOMAIN}`)"
      - "traefik.http.routers.dashboard.service=api@internal"
      - "traefik.http.routers.dashboard.entrypoints=websecure"
      - "traefik.http.routers.dashboard.tls.certresolver=letsencrypt"
      - "traefik.http.routers.dashboard.middlewares=auth"
      # Basic auth for dashboard (user: admin, pass: changeme - CHANGE THIS!)
      - "traefik.http.middlewares.auth.basicauth.users=admin:$$apr1$$8EVjn/nj$$GiLUZqcbueTFeD23SuB6x0"

  backend:
    image: ${REGISTRY:-ghcr.io}/${IMAGE_PREFIX:-adedipe23/healthpulse-cicd}-backend:${TAG:-latest}
    container_name: healthpulse-backend-${ENVIRONMENT:-prod}
    restart: unless-stopped
    networks:
      - traefik-public
    healthcheck:
      test: ["CMD", "python", "-c", "import urllib.request; urllib.request.urlopen('http://localhost:5000/api/v1/health')"]
      interval: 10s
      timeout: 3s
      retries: 10
    labels:
      - "traefik.enable=false"  # Backend is not directly exposed

  frontend:
    image: ${REGISTRY:-ghcr.io}/${IMAGE_PREFIX:-adedipe23/healthpulse-cicd}-frontend:${TAG:-latest}
    container_name: healthpulse-frontend-${ENVIRONMENT:-prod}
    restart: unless-stopped
    depends_on:
      backend:
        condition: service_healthy
    networks:
      - traefik-public
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.healthpulse-${ENVIRONMENT:-prod}.rule=Host(`${DOMAIN}`)"
      - "traefik.http.routers.healthpulse-${ENVIRONMENT:-prod}.entrypoints=websecure"
      - "traefik.http.routers.healthpulse-${ENVIRONMENT:-prod}.tls.certresolver=letsencrypt"
      - "traefik.http.services.healthpulse-${ENVIRONMENT:-prod}.loadbalancer.server.port=80"

networks:
  traefik-public:
    name: traefik-public
    driver: bridge

volumes:
  traefik-certificates:
    name: traefik-certificates

