# HealthPulse - Deployment Guide

This guide covers the complete setup for deploying HealthPulse to Oracle Linux 9 with Traefik reverse proxy and automatic SSL certificates.

## üìã Prerequisites

- Oracle Cloud server running Oracle Linux 9
- SSH access to the server
- Two domain names (or subdomains) configured:
  - Production domain (e.g., `healthpulse.yourdomain.com`)
  - Development domain (e.g., `dev.healthpulse.yourdomain.com`)
- GitHub repository with Actions enabled

---

## üîß Part 1: Oracle Server Setup (One-Time)

### Step 1: Connect to Your Oracle Server

```bash
ssh opc@<your-server-ip>
```

### Step 2: Install Docker

```bash
# Update system
sudo dnf update -y

# Install Docker
sudo dnf install -y dnf-utils
sudo dnf config-manager --add-repo https://download.docker.com/linux/centos/docker-ce.repo
sudo dnf install -y docker-ce docker-ce-cli containerd.io docker-buildx-plugin docker-compose-plugin

# Start and enable Docker
sudo systemctl start docker
sudo systemctl enable docker

# Add your user to docker group (to run docker without sudo)
sudo usermod -aG docker $USER

# Log out and back in for group changes to take effect
exit
```

### Step 3: Configure Firewall

```bash
# Reconnect to server
ssh opc@<your-server-ip>

# Open HTTP and HTTPS ports
sudo firewall-cmd --permanent --add-service=http
sudo firewall-cmd --permanent --add-service=https
sudo firewall-cmd --reload

# Verify Docker is running
docker --version
docker compose version
```

### Step 4: Create Deployment Directory

```bash
mkdir -p /home/opc/healthpulse
cd /home/opc/healthpulse
```

### Step 5: Configure SELinux (Oracle Linux specific)

```bash
# Allow Docker to bind to ports 80 and 443
sudo setsebool -P httpd_can_network_connect 1
sudo semanage port -a -t http_port_t -p tcp 80 2>/dev/null || true
sudo semanage port -a -t http_port_t -p tcp 443 2>/dev/null || true
```

---

## üåê Part 2: Domain Configuration

### Option A: Using DuckDNS (Free & Easy)

1. Go to https://www.duckdns.org/
2. Sign in with your preferred method
3. Create two subdomains:
   - `healthpulse` ‚Üí points to your Oracle server IP
   - `healthpulse-dev` ‚Üí points to your Oracle server IP
4. Your domains will be:
   - Production: `healthpulse.duckdns.org`
   - Development: `healthpulse-dev.duckdns.org`

### Option B: Using Your Own Domain

1. Add two A records in your DNS provider:
   ```
   healthpulse.yourdomain.com     ‚Üí <oracle-server-ip>
   dev.healthpulse.yourdomain.com ‚Üí <oracle-server-ip>
   ```
2. Wait for DNS propagation (5-30 minutes)

### Verify DNS Configuration

```bash
# Test from your local machine
nslookup healthpulse.duckdns.org
nslookup healthpulse-dev.duckdns.org
```

---

## üîê Part 3: GitHub Secrets Configuration

Go to your GitHub repository ‚Üí Settings ‚Üí Secrets and variables ‚Üí Actions ‚Üí New repository secret

Add the following secrets:

| Secret Name | Value | Example |
|------------|-------|---------|
| `SERVER_IP` | Your Oracle server IP | `123.45.67.89` |
| `SSH_USER` | SSH username | `opc` |
| `SSH_PRIVATE_KEY` | Your SSH private key | (see below) |
| `DOMAIN_PROD` | Production domain | `healthpulse.duckdns.org` |
| `DOMAIN_DEV` | Development domain | `healthpulse-dev.duckdns.org` |
| `ACME_EMAIL` | Your email for SSL certs | `you@example.com` |

### Generating SSH Key Pair

On your **local machine**:

```bash
# Generate new SSH key pair
ssh-keygen -t ed25519 -C "github-actions-deploy" -f ~/.ssh/healthpulse_deploy

# Copy public key to Oracle server
ssh-copy-id -i ~/.ssh/healthpulse_deploy.pub opc@<your-server-ip>

# Display private key (copy this to GitHub Secret SSH_PRIVATE_KEY)
cat ~/.ssh/healthpulse_deploy
```

Copy the **entire private key** including the `-----BEGIN` and `-----END` lines to the `SSH_PRIVATE_KEY` secret.

---

## üöÄ Part 4: Deploy

### First Deployment

1. Push to `develop` branch:
   ```bash
   git checkout develop
   git push origin develop
   ```

2. Push to `main` branch:
   ```bash
   git checkout main
   git push origin main
   ```

3. Monitor deployment in GitHub Actions tab

### Verify Deployment

After successful deployment, visit:
- Production: `https://healthpulse.duckdns.org` (or your domain)
- Development: `https://healthpulse-dev.duckdns.org` (or your domain)

SSL certificates will be automatically generated by Traefik using Let's Encrypt.

---

## üìä Monitoring & Troubleshooting

### Check Running Containers

```bash
ssh opc@<your-server-ip>
cd /home/opc/healthpulse
docker compose -f docker-compose.traefik.yml ps
```

### View Logs

```bash
# All services
docker compose -f docker-compose.traefik.yml logs -f

# Specific service
docker compose -f docker-compose.traefik.yml logs -f traefik
docker compose -f docker-compose.traefik.yml logs -f frontend
docker compose -f docker-compose.traefik.yml logs -f backend
```

### Restart Services

```bash
docker compose -f docker-compose.traefik.yml restart
```

---

## üîÑ CI/CD Workflow

The pipeline automatically:

1. **On push to `develop` or `main`:**
   - Runs backend tests
   - Builds multi-arch Docker images (amd64 + arm64)
   - Pushes to GitHub Container Registry
   - Deploys to Oracle server
   - Routes to appropriate domain based on branch

2. **Branch ‚Üí Domain Mapping:**
   - `main` ‚Üí Production domain
   - `develop` ‚Üí Development domain

---

## üõ°Ô∏è Security Notes

- Traefik automatically handles SSL/TLS certificates via Let's Encrypt
- Certificates auto-renew before expiration
- HTTP traffic is automatically redirected to HTTPS
- Backend is not directly exposed (only accessible via frontend proxy)

---

## üìù Next Steps

- [ ] Set up monitoring (Prometheus/Grafana)
- [ ] Configure backup strategy
- [ ] Set up log aggregation
- [ ] Add health check notifications
- [ ] Configure rate limiting in Traefik

